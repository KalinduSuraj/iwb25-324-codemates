<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BinBuddy Customer</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://maps.googleapis.com/maps/api/js?key=YOUR_API_KEY&libraries=geometry"></script>
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #F0FDF4; }
        #map { height: 100%; min-height: 400px; border-radius: 1rem; }
        .notification-enter { animation: slideIn 0.5s ease-out forwards; }
        @keyframes slideIn {
            from { opacity: 0; transform: translateY(-20px); }
            to { opacity: 1; transform: translateY(0); }
        }
    </style>
</head>
<body class="text-gray-800">

    <div id="app" class="flex flex-col min-h-screen">
        <header id="navbar-container" class="bg-white/80 backdrop-blur-md shadow-md sticky top-0 z-40"></header>
        <main id="main-content" class="flex-grow"></main>
        <footer id="footer-container" class="bg-green-800 text-white"></footer>
    </div>

    <div id="feedbackModal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden items-center justify-center p-4"></div>

    <script>
    document.addEventListener('DOMContentLoaded', () => {

        // =================================================================================
        // STATE & API CONFIG
        // =================================================================================

        const state = {
            user: null, // Populated by API
            billing: null, // Populated by API
            collectionStatus: 'idle', // Updated by API
            collectorLocation: null,
            notifications: [],
            showFeedbackModal: false,
        };

        // --- API HELPER FUNCTIONS ---

        // NEW: Fetches all initial data for the dashboard
        async function fetchDashboardData() {
            const token = localStorage.getItem('authToken');
            try {
                // REPLACE WITH YOUR ACTUAL ENDPOINT
                const response = await fetch('/api/customer/dashboard', {
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                if (!response.ok) throw new Error('Could not fetch dashboard data.');
                
                const data = await response.json(); // Expects { user: {...}, billing: {...}, collectionStatus: '...' }

                // Update state with data from the API
                state.user = data.user;
                state.billing = data.billing;
                state.collectionStatus = data.collectionStatus || 'idle';

            } catch (error) {
                console.error("API Error:", error);
                // Redirect on failure, as the page can't function without this data
                handleLogout();
            }
        }

        // NEW: API call to request a new collection
        async function requestCollectionAPI() {
            const token = localStorage.getItem('authToken');
            // REPLACE WITH YOUR ACTUAL ENDPOINT
            const response = await fetch('/api/collections/request', {
                method: 'POST',
                headers: { 'Authorization': `Bearer ${token}` }
            });
            if (!response.ok) throw new Error('Failed to request collection.');
            return await response.json();
        }
        
        // NEW: API call to submit feedback
        async function submitFeedbackAPI(rating, comment) {
             const token = localStorage.getItem('authToken');
             // REPLACE WITH YOUR ACTUAL ENDPOINT
             const response = await fetch('/api/feedback', {
                 method: 'POST',
                 headers: {
                     'Authorization': `Bearer ${token}`,
                     'Content-Type': 'application/json'
                 },
                 body: JSON.stringify({ rating, comment })
             });
             if (!response.ok) throw new Error('Failed to submit feedback.');
             return await response.json();
        }

        // =================================================================================
        // AUTHENTICATION
        // =================================================================================

        // MODIFIED: Only validates the token, data fetching is now separate.
        function checkAuthToken() {
            const token = localStorage.getItem('authToken');
            if (!token) {
                window.location.href = 'index.html';
                return false;
            }
            try {
                const payload = JSON.parse(atob(token.split('.')[1]));
                const isExpired = payload.exp * 1000 < Date.now();
                if (isExpired || payload.role !== 'customer') {
                   handleLogout();
                   return false;
                }
                return true; // Token is valid
            } catch (e) {
                handleLogout();
                return false;
            }
        }

        function handleLogout() {
            localStorage.removeItem('authToken');
            window.location.href = 'index.html';
        }

        // =================================================================================
        // COMPONENTS (HTML TEMPLATES)
        // =================================================================================

        const Navbar = () => `
            <nav class="container mx-auto px-4 sm:px-6 lg:px-8">
                <div class="flex items-center justify-between h-16">
                    <div class="flex items-center">
                        <a href="#" class="flex-shrink-0 text-2xl font-bold text-green-700 flex items-center">
                            <svg class="h-8 w-8 mr-2 text-green-500" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm4 0a1 1 0 012 0v6a1 1 0 11-2 0V8z" clip-rule="evenodd" /></svg>
                            BinBuddy
                        </a>
                    </div>
                    <div class="hidden md:block">
                        <div class="flex items-center space-x-4">
                            <span class="text-sm text-gray-700">Welcome, ${state.user.name}</span>
                            <button id="logoutBtn" class="bg-red-500 text-white px-4 py-2 rounded-full text-sm font-semibold hover:bg-red-600">Logout</button>
                        </div>
                    </div>
                </div>
            </nav>`;

        const Footer = () => `
            <div class="container mx-auto px-4 sm:px-6 lg:px-8 py-12 text-center text-sm text-green-300">
                <p>&copy; ${new Date().getFullYear()} BinBuddy. All Rights Reserved.</p>
            </div>`;
        
        // MODIFIED: Reads billing info from state
        const DashboardPage = () => {
             const getStatusPill = (status) => ({
                idle: '<span class="bg-gray-200 text-gray-800 text-xs font-medium px-2.5 py-0.5 rounded-full">Idle</span>',
                requested: '<span class="bg-blue-100 text-blue-800 text-xs font-medium px-2.5 py-0.5 rounded-full">Requested</span>',
                accepted: '<span class="bg-yellow-100 text-yellow-800 text-xs font-medium px-2.5 py-0.5 rounded-full">Accepted</span>',
                enroute: '<span class="bg-purple-100 text-purple-800 text-xs font-medium px-2.5 py-0.5 rounded-full">En Route</span>',
                completed: '<span class="bg-green-100 text-green-800 text-xs font-medium px-2.5 py-0.5 rounded-full">Completed</span>',
            }[status] || '');

            const notificationsHTML = state.notifications.map(n => `
                <div class="notification-enter flex items-start gap-3 p-3 bg-white rounded-lg shadow-sm">
                    <div class="w-8 h-8 rounded-full bg-green-100 flex items-center justify-center flex-shrink-0">
                       <svg class="w-5 h-5 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                    </div>
                    <div>
                       <p class="text-sm font-semibold text-gray-800">${n.title}</p>
                       <p class="text-xs text-gray-500">${n.message}</p>
                    </div>
                </div>`).join('');

            return `
            <div class="container mx-auto px-4 sm:px-6 lg:px-8 py-8">
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                    <div class="lg:col-span-1 space-y-6">
                        <div class="bg-white p-6 rounded-2xl shadow-lg">
                            <h2 class="text-2xl font-bold text-gray-800 mb-4">Request Collection</h2>
                            ${state.collectionStatus === 'idle' || state.collectionStatus === 'completed' ? `
                            <p class="text-gray-600 mb-4 text-sm">Ready for a pickup?</p>
                            <button id="collectNowBtn" class="w-full text-white bg-green-600 hover:bg-green-700 font-semibold rounded-lg py-3">Collect Now</button>` : `
                            <p class="text-gray-600 mb-2 text-sm">Your collection is in progress.</p>
                            <div class="flex items-center"><span class="font-bold mr-2">Status:</span>${getStatusPill(state.collectionStatus)}</div>`}
                        </div>

                        <div class="bg-white p-6 rounded-2xl shadow-lg">
                            <h2 class="text-2xl font-bold text-gray-800 mb-4">Billing & Payments</h2>
                            <div class="space-y-3 text-sm">
                                <div class="flex justify-between"><span>Next Bill Date:</span><span class="font-medium">${state.billing.nextBillDate}</span></div>
                                <div class="flex justify-between font-bold text-base"><span>Amount Due:</span><span>LKR ${state.billing.amountDue.toFixed(2)}</span></div>
                            </div>
                            <div class="mt-4 pt-4 border-t border-gray-200 flex flex-col sm:flex-row gap-3">
                                <button class="flex-1 text-white bg-green-600 hover:bg-green-700 font-semibold rounded-lg text-sm px-5 py-3 text-center">Pay with Card</button>
                                <button class="flex-1 text-green-700 bg-green-100 hover:bg-green-200 font-semibold rounded-lg text-sm px-5 py-3 text-center">Cash on Delivery</button>
                            </div>
                            <p class="text-xs text-gray-500 mt-3 text-center">You can also pay in cash when our collector arrives.</p>
                        </div>

                        <div class="bg-white p-6 rounded-2xl shadow-lg">
                            <h2 class="text-2xl font-bold text-gray-800 mb-4">Notifications</h2>
                            <div id="notifications-list" class="space-y-3 max-h-60 overflow-y-auto pr-2">
                                ${notificationsHTML || '<p class="text-sm text-gray-500">No new notifications.</p>'}
                            </div>
                        </div>
                    </div>
                    <div class="lg:col-span-2 bg-white p-2 rounded-2xl shadow-lg">
                        <div id="map"></div>
                    </div>
                </div>
            </div>`;
        };
        
        const FeedbackModal = () => `
            <div class="bg-white rounded-2xl shadow-2xl w-full max-w-md mx-auto p-8">
                <h2 class="text-2xl font-bold text-center">Collection Complete!</h2>
                <p class="mt-2 text-center text-gray-600">How was your service?</p>
                <div id="starRating" class="flex justify-center my-6 text-4xl text-gray-300">
                     ${[1,2,3,4,5].map(star => `<span class="star cursor-pointer hover:text-yellow-400" data-rating="${star}">☆</span>`).join('')}
                </div>
                <textarea id="feedbackComment" class="w-full p-3 border rounded-lg" rows="3" placeholder="Additional comments..."></textarea>
                <button id="submitFeedbackBtn" class="mt-4 w-full text-white bg-green-600 hover:bg-green-700 font-semibold rounded-lg py-3">Submit</button>
            </div>`;
        
        // =================================================================================
        // MAP & UI LOGIC
        // =================================================================================

        let map, userMarker, collectorMarker, directionsRenderer;
        // NOTE: All map functions remain the same as they depend on Google Maps API, not our mock data.
        function initMap() { /* ... unchanged ... */ }
        function updateCollectorPosition(location, isEnroute) { /* ... unchanged ... */ }
        
        // REMOVED: No longer simulating, this would be driven by real-time data (e.g., WebSockets) from the backend.
        // function simulateCollectorMovement() { ... }

        function render() {
            document.getElementById('navbar-container').innerHTML = Navbar();
            document.getElementById('main-content').innerHTML = DashboardPage();
            document.getElementById('footer-container').innerHTML = Footer();
            initMap();
            
            if (state.collectorLocation) {
                updateCollectorPosition(state.collectorLocation, state.collectionStatus === 'enroute');
            }

            const feedbackModal = document.getElementById('feedbackModal');
            if (state.showFeedbackModal) {
                feedbackModal.innerHTML = FeedbackModal();
                feedbackModal.classList.remove('hidden');
                feedbackModal.classList.add('flex');
                addFeedbackModalListeners();
            } else {
                feedbackModal.classList.add('hidden');
            }
            addEventListeners();
        }

        function updateState(newState) {
            Object.assign(state, newState);
            render();
        }

        function addNotification(title, message) {
            state.notifications.unshift({ title, message });
            if (state.notifications.length > 5) state.notifications.pop();
        }

        // =================================================================================
        // EVENT HANDLERS & LISTENERS
        // =================================================================================

        function addEventListeners() {
            document.getElementById('logoutBtn').addEventListener('click', handleLogout);
            const collectNowBtn = document.getElementById('collectNowBtn');
            if (collectNowBtn) collectNowBtn.addEventListener('click', handleRequestCollection);
        }

        function addFeedbackModalListeners() {
            document.getElementById('submitFeedbackBtn').addEventListener('click', handleSubmitFeedback);
            // Star rating UI logic
            const stars = document.querySelectorAll('.star');
            stars.forEach(star => {
                star.addEventListener('click', () => {
                    const rating = star.dataset.rating;
                    document.getElementById('starRating').dataset.finalRating = rating;
                    stars.forEach(s => {
                        s.innerHTML = s.dataset.rating <= rating ? '★' : '☆';
                        s.classList.toggle('text-yellow-400', s.dataset.rating <= rating);
                    });
                });
            });
        }
        
        // MODIFIED: Makes an API call instead of simulating
        async function handleRequestCollection() {
            const btn = document.getElementById('collectNowBtn');
            btn.disabled = true;
            btn.textContent = "Requesting...";

            try {
                await requestCollectionAPI();
                addNotification("Request Sent", "We're finding a collector for you.");
                updateState({ collectionStatus: 'requested' });
            } catch (error) {
                addNotification("Error", "Could not process your request. Please try again.");
                btn.disabled = false;
                btn.textContent = "Collect Now";
            }
        }
        
        // NEW: Handles submitting the feedback form
        async function handleSubmitFeedback() {
             const btn = document.getElementById('submitFeedbackBtn');
             btn.disabled = true;
             btn.textContent = "Submitting...";
             
             const rating = document.getElementById('starRating').dataset.finalRating || 0;
             const comment = document.getElementById('feedbackComment').value;
             
             try {
                 await submitFeedbackAPI(rating, comment);
                 updateState({ showFeedbackModal: false, collectionStatus: 'idle' });
             } catch (error) {
                 alert("Could not submit feedback. Please try again.");
                 btn.disabled = false;
                 btn.textContent = "Submit";
             }
        }

        // =================================================================================
        // INITIALIZATION
        // =================================================================================

        async function init() {
            // Show loading state
            document.getElementById('main-content').innerHTML = '<div class="text-center p-10">Loading your dashboard...</div>';

            if (checkAuthToken()) {
                await fetchDashboardData();
                render();
            }
        }

        init();
    });
</script>
</body>
</html>
